<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>发布房源</title>
    <link rel="icon" href="../../resources/images/favicon.ico"/>
    <!--先引入vue.js库-->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!--axios-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="../js/jquery-2.1.3.js"></script>
    <!--穿梭框的layui样式库-->
    <!--<link rel="stylesheet" href="../layui/css/layui.css" >-->
    <style>
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }
        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 178px;
            height: 178px;
            line-height: 178px;
            text-align: center;
        }
        .avatar {
            width: 178px;
            height: 178px;
            display: block;
        }
        .el-form-item__content {
            line-height: 40px;
            position: relative;
            font-size: 14px;
            width: 200px;
        }
        /* 设置穿梭框的 宽高 */
        .el-transfer-panel{
            width : 350px;
            height: 400px;
        }
        .el-transfer-panel__list {
            margin: 0;
            padding: 6px 0;
            list-style: none;
            height: 390px;
            overflow: auto;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }
        .el-transfer__buttons {
            display: inline-block;
            vertical-align: middle;
            padding: 0 30px;
        }
        .el-form-item__label {
            text-align: right;
            vertical-align: middle;
            float: left;
            font-size: 14px;
            color: #606266;
            line-height: 40px;
            padding: 0 12px 0 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 30px;
        }
        .div1{
            height: 1000px;
        }
        .el-container {
            height: 100%;
            margin-bottom: 40px;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
        }
        .el-header
        body .el-main {
            height: 510px;
            background-color: #EBEEF5;
            color: #333;
            text-align: center;
        }
        html,body{
            margin:0px;
            height:100%;
        }
        /*img{*/
            /*width:50px;*/
            /*height: 50px;*/
        /*}*/

    </style>
</head>
<body>
<!--<script src="../layui/layui.js" charset="utf-8"></script>-->
<script>

</script>

<div id="app" class="div1">
<el-container>
    <el-header>
        <!--<i class="el-icon-office-building"></i>../demo4/images/houses2/6.jpg-->
        <!--<img src="../images/houses2/6.jpg" height="50" width="50"/>-->
        <!--<img src="../images/houses2/6.jpg" height="50" width="50"/>-->
        <!--<image src="../resources/images/houses2/6.jpg"></image>-->
        <!--<img src="../images/houses/zufang1.jpg" height="50" width="50"/>-->
        <!--<el-input icon="el-icon-office-building"></el-input>-->
        <!--<img src="../images/houses2/6.jpg" height="488" width="500"/>-->
        <h1>房源添加</h1>
    </el-header>
    <el-main>
    <el-form :model="ruleForm" :rules="rules" ref="ruleForm" label-width="100px" class="demo-ruleForm">
    <!--<el-col :span="8">-->
        <!--<el-form-item label="房屋编号" type="hidden" prop="houseid">-->
            <!--<el-input  v-model="ruleForm.houseid" type="hidden"  readonly="readonly"></el-input>-->
        <!--</el-form-item>-->
    <!--</el-col>-->
<el-row :gutter="20">
    <!--<el-form :inline="true" :model="ruleForm" class="demo-form-inline" margin-left="30px">-->
    <el-col :span="6">
        <el-form-item label="房屋编号" type="hidden" prop="houseid">
            <el-input  v-model="ruleForm.houseid" readonly="readonly"></el-input>
        </el-form-item>
    </el-col>
        <el-col :span="6">
            <el-form-item label="房屋描述" prop="htitle">
                <el-input  v-model="ruleForm.htitle"placeholder="如:某小区，几室几厅"></el-input>
            </el-form-item>
        </el-col>
        <el-col :span="6">
            <el-form-item label="房屋楼层" prop="hfloor">
                <el-input v-model="ruleForm.hfloor"></el-input>
            </el-form-item>
        </el-col>
        <el-col :span="6">
            <el-form-item label="设定租金" prop="hrent">
                <el-input v-model="ruleForm.hrent"></el-input>
            </el-form-item>
        </el-col>
    <!--</el-form>-->
</el-row>
    <!--第二行-->
<el-row :gutter="20">
    <el-col :span="6">
        <el-form-item label="详细地址" prop="hadr">
            <el-input v-model="ruleForm.hadr" placeholder="如:某区-某街道-某小区"></el-input>
        </el-form-item>
    </el-col>
    <el-col :span="6">
        <el-form-item label="占地面积" prop="harea">
            <el-input v-model="ruleForm.harea"></el-input>
        </el-form-item>
    </el-col>
    <el-col :span="6">
        <el-form-item label="房屋朝向" prop="orientation">
            <el-input v-model="ruleForm.orientation" placeholder="如:坐北朝南"></el-input>
        </el-form-item>
    </el-col>
    <el-col :span="6">
        <el-form-item label="出租方式" prop="leaseWay">
            <!--<el-input v-model="ruleForm.leaseWay" placeholder="如:合租/单租"></el-input>-->
            <el-select v-model="ruleForm.leaseWay">
                <el-option value="合租">合租</el-option>
                <el-option value="单租">单租</el-option>
            </el-select>
        </el-form-item>
    </el-col>

   </el-row>


    <!--房东编号，应该是在跳转页面后直接显示出来的-->
    <!--房东姓名，应该是在跳转页面后直接显示出来的-->
<!--第三行-->
<el-row :gutter="20">
    <!--<el-col :span="8">-->
        <!--<el-form-item label="经纪人" prop="agentid">-->
            <!--<el-select v-model="ruleForm.agentid" >-->
                <!--<el-option-->
                        <!--v-for="item in agents"-->
                        <!--:key="item.id"-->
                        <!--:label="item.ename"-->
                        <!--:value="item.id">-->
                <!--</el-option>-->
            <!--</el-select>-->
        <!--</el-form-item>-->
    <!--</el-col>-->
    <el-col :span="6">
    <el-form-item label="经纪人" prop="agentid">
        <el-input v-model="ruleForm.agentid" readonly="true"></el-input>
    </el-form-item>
    </el-col>

            <!--<el-select v-model="ruleForm.leaseWay" >-->
                <!--<el-option-->
                    <!--v-for="item in states"-->
                    <!--:key="item.id"-->
                    <!--:label="item.name"-->
                    <!--:value="item.id">-->
                <!--</el-option>-->
            <!--</el-select>-->
            <!---->

    <!--<el-form :inline="true" :model="ruleForm" class="demo-form-inline" margin-left="30px">-->
    <el-col :span="6">
        <el-form-item label="发布日期" :label-width="formLabelWidth">
            <el-date-picker
                    v-model="ruleForm.releasedate"
                    align="right"
                    type="date"
                    placeholder="选择日期"
                    :picker-options="pickerOptions" >
            </el-date-picker>
        </el-form-item>
    </el-col>
    <el-col :span="6">
        <el-form-item label="房东姓名" prop="cname">
            <el-input v-model="ruleForm.cname"></el-input>
        </el-form-item>
    </el-col>
    <el-col :span="6">
        <el-form-item label="房东电话" prop="cphone">
            <el-input v-model="ruleForm.cphone"></el-input>
        </el-form-item>
    </el-col>
    <!--</el-form>-->
</el-row>

<!--第四行-->
<el-row :gutter="20">
    <el-col >
        <el-form-item label="配置家具" :label-width="formLabelWidth" margin-left="30px">
            <span id="tbd" style="width: 1000px;"></span>
        </el-form-item>
    </el-col>
</el-row>

<!--第五行-->
<!--使居中：type="flex" justify="center"-->
<el-row :gutter="20" >
    <el-col :span="6">
        <!--上传房屋图片-->
        <el-form-item label="房屋图片" :label-width="formLabelWidth" margin-left="30px">
            <el-upload
                    name="headPic"
                    class="avatar-uploader"
                    action="/demo4/house/uploadHeadPic"
                    :show-file-list="false"
                    :on-success="handleAvatarSuccess"
                    :before-upload="beforeAvatarUpload">
                <img v-if="imageUrl" :src="imageUrl" class="avatar">
                <i v-else class="el-icon-plus avatar-uploader-icon"></i>
            </el-upload>
        </el-form-item>
    </el-col>
</el-row>

<!--第六行-->
<el-row :gutter="20" type="flex" justify="center">
    <el-col :span="8" >
    <el-form-item>
        <el-button type="primary" @click="saveData">
            <el-button type="primary" @click="saveFurniture" style="margin:0px;padding:0px">提交</el-button>
        </el-button>
        <el-button type="primary" @click="loadData">重置</el-button>
    </el-form-item>
    </el-col>
</el-row>

</el-form>
</el-main>
</el-container>
</div>

<script>
    // 获取家具列表的异步请求
    $(function () {
        $("#tbd").empty();
        $.ajax({
            url:"/demo4/part/furnitures",
            type:"POST",
            dataType:"json",
            success:function (data) {
                var tr="<table style=\"width: 1000px;\"><tr>";
                for (var i = 0; i < data.length; i++) {
                    var item=data[i];
                    // alert(item.furnitureid);
                    tr+="<td><input type='checkbox' name='checkbox' value='"+item.furnitureid+"'/>"+item.furniturename+"</td>";
                }
                tr+="</tr></table>";
                $("#tbd").append(tr);
            }
        })
    });

    // vue的数据处理
   var vue=new Vue({
       el: "#app",
       data: {
           ruleForm: {
               houseid:'',
               htitle: '',
               hadr: '',
               state:'2',
               leaseWay:'',
               agentid:'',
               hrent: '',
               hfloor: '',
               harea: '',
               orientation: '',
               releasedate:'',
               // furnitures:[],
               headPic:'',
               headPicName:'',
               cname:'',
               cphone:''
           },
           states:[],
           // agents:[],
           agent:{},
           furnitureForm:{
               houseid:'',
               furnitureid:''
           },
           imageUrl:'',
           rules: {
               htitle: [
                   {required: true, message: '请输入房屋描述', trigger: 'blur'},
               ],
               hadr: [
                   {required: true, message: '某区-某道路-某小区', trigger: 'blur'}
               ],
               hrent: [
                   {required: true, message: '请设定房屋租金', trigger: 'blur'}
               ],
               harea: [
                   {required: true, message: '请描述房屋面积', trigger: 'blur'}
               ],
               cname: [
                   {required: true, message: '请输入房东姓名', trigger: 'blur'}
               ],
               cphone: [
                   {required: true, message: '请输入房东电话', trigger: 'blur'}
               ]
           },
           pickerOptions:{
               disabledDate:function(time) {
                   return time.getTime() > Date.now();
               },
               shortcuts: [{
                   text: '今天',
                   onClick:function(picker) {
                       picker.$emit('pick', new Date());
                   }
               }]
           },

       },
       created: function () {
           var self = this;
           this.loadData();
           axios.post('/demo4/getName')
               .then(function (response) {
                   self.ruleForm.agentid=response.data.emp.enumber;
               });
           // var Num="";
           // for (var i = 0; i < 8; i++) {
           //     Num+=Math.floor(Math.random()*10);
           // }
           // self.ruleForm={id:'', houseid:Num, htitle:'', hadr:'',state:'2',
           //     hrent:'', headPic:'',headPicName:'', hfloor:'', harea:'', orientation:'',
           //     releasedate:'', hdesc:'',leaseWay:'',cname:'', cphone:''
           // };
           // 向房子家具中间表中存入的数据
           // self.furnitureForm={houseid:Num,furnitureid:''};

           //只查出“待审核”这一条状态
           axios.post('/demo4/part/state2')
               .then(function (response) {
                   self.states=response.data;
               });
       },
       methods: {
           loadData:function(){
               var self=this;
               var Num="";
               for (var i = 0; i < 8; i++) {
                   Num+=Math.floor(Math.random()*10);
               }
               this.ruleForm={id:'', houseid:Num, htitle:'', hadr:'',state:'2',
                   hrent:'', headPic:'',headPicName:'', hfloor:'', harea:'', orientation:'',
                   releasedate:'', hdesc:'',leaseWay:'',cname:'', cphone:'',agentid:''
               };
               // 向房子家具中间表中存入的数据
               this.furnitureForm={houseid:Num,furnitureid:''};

               //刷新页面时，将所有选中的复选框设为未选中状态
               var checkbox=$('input[name=\'checkbox\']:checked');
               for (var i = 0; i < checkbox.length; i++) {
                   checkbox[i].checked=false;
               }
           },
           saveData:function () {
               var self=this;
               axios.post("/demo4/house/save",this.ruleForm)
                   .then(function (response) {

                       if (response.data==1){
                           self.$message({
                               message: '恭喜你，操作成功',
                               type: 'success'
                           });
                           self.loadData();
                           axios.post('/demo4/getName')
                               .then(function (response) {
                                   self.ruleForm.agentid=response.data.emp.enumber;
                               });
                       }else{
                           self.$message.error('错了哦，操作失败');
                       }
                   });
               axios.post("/demo4/part/addHost",this.ruleForm)
                   .then(function (response) {
                       if (response.data==1){
                           self.loadData();
                       }else{
                           self.$message.error('错了哦，操作失败');
                       }
                   });
               this.imageUrl='';
           },
           saveFurniture:function(){
               // var Num="";
               // for (var i = 0; i < 8; i++) {
               //     Num+=Math.floor(Math.random()*10);
               // }
               // // 向房子家具中间表中存入的数据
               // this.furnitureForm={houseid:Num,furnitureid:''}

               var self=this;
               // 写一个数组存入所有的家具编号
               var ids=[];
               $('input[name=\'checkbox\']:checked').each(function () {
                   ids.push($(this).val());
               });
               $.ajax({
                   url:"/demo4/house/saveFurniture",
                   type:"POST",
                   data:{furnitures:ids.toString(),houseid:this.furnitureForm.houseid},
                   dataType:"json",
                   success:function (msg) {
                       if(msg==true){
                           // $('input[name=\'checkbox\']:checked').each(function () {
                           //     $('input[name=\'checkbox\']:checked=fal')
                           // });
                           self.loadData();
                       }else{
                           self.$message.error('错了哦，操作失败');
                       }
                   }
               });
           },
           handleAvatarSuccess:function(res, file) {
               this.imageUrl = URL.createObjectURL(file.raw);
               this.ruleForm.headPicName=file.response.originalFilename;
               this.ruleForm.headPic=file.response.newFileName;
           },
           beforeAvatarUpload:function(file) {
               const isJPG = file.type === 'image/jpeg';
               const isLt2M = file.size / 1024 / 1024 < 2;
               if (!isJPG) {
                   this.$message.error('上传头像图片只能是 JPG 格式!');
               }
               if (!isLt2M) {
                   this.$message.error('上传头像图片大小不能超过 2MB!');
               }
               return isJPG && isLt2M;
           }
       }
   })


</script>

</body>
</html>